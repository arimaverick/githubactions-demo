name: autoPR

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: respondDispatcher
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BRANCH: upgrade_version_${{ github.run_id }}
    runs-on: ubuntu-latest
    steps: 
    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.client_payload.ref }}
    - name: dispatcher-trap
      id: dispatchtrap
      env:
        version: ${{ github.event.client_payload.version }}
        LABEL: update version
      run: |
        git config --global user.name ${{ github.workflow }}
        git config --global user.email "${{ github.workflow }}@users.noreply.github.com"
        gh api repos/{owner}/{repo}/labels -f name="$LABEL" -f color=2b9bdf -f description="update version" || true
        git checkout -b $BRANCH
        echo "Latest Verion: $version"
        cat $version > version.txt
        git commit -a -m "Update version to $version"
        git push --set-upstream origin $BRANCH
        gh pr create -l "$LABEL" -B main -b "This is an automated PR" -t "Version Update" 
        pr_link=`gh pr list -l "$LABEL"`
        echo $pr_link
        gh pr merge $pr_link --auto --merge
        gh pr review $pr_link --approve -b "interesting"
        gh pr close $pr_link -d $BRANCH