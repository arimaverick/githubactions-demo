name: autoPR

on:
  repository_dispatch:

jobs:
  build:
    name: respondDispatcher
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BRANCH: upgrade_version_${{ github.run_id }}
    runs-on: ubuntu-latest
    steps: 
    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.client_payload.ref }}
    - name: dispatcher-trap
      id: dispatchtrap
      env:
        version: ${{ github.event.client_payload.version }}
        LABEL: update version
        repo_token: ${{ secrets.REPO_DISPATCH_PAT }}
      run: |
        git config --global user.name ${{ github.workflow }}
        git config --global user.email "${{ github.workflow }}@users.noreply.github.com"
        gh api repos/{owner}/{repo}/labels -f name="$LABEL" -f color=2b9bdf -f description="update version" || true
        git checkout -b $BRANCH
        echo "Latest Verion: $version"
        echo $version > version.txt
        git commit -a -m "Update version to $version"
        git push --set-upstream origin $BRANCH
        git config -l
        gh pr create -l "$LABEL" -B main -b "This is an automated PR" -t "Version Update" --reviewer arimaverick
        pr_id=`gh pr list -l "$LABEL" | cut -f1`
        echo "PR Link: $pr_id"
        echo "::set-output name=pr_url::$pr_id"